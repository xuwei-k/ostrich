<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Histogram.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2010-2011 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> com.twitter.ostrich.stats

<span class="keyword">import</span> scala.annotation.tailrec

<span class="keyword">object</span> <a title="object com.twitter.ostrich.stats.Histogram" id="9321">Histogram</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="comment">/*
   * The midpoint of each bucket is +/- 5% from the boundaries.
   *   (0..139).map { |n| (1.10526315 ** n).to_i + 1 }.uniq
   * Bucket i is the range from BUCKET_OFFSETS(i-1) (inclusive) to
   * BUCKET_OFFSETS(i) (exclusive).
   * The last bucket (the &quot;infinity&quot; bucket) is from 1100858 to infinity.
   */</span>
  <span class="keyword">val</span> <a title="Array[Int]" id="39883">BUCKET_OFFSETS</a> =
    <span title="(x: Int,xs: Int*)Array[Int]">Array</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span>, <span title="Int(2)" class="int">2</span>, <span title="Int(3)" class="int">3</span>, <span title="Int(4)" class="int">4</span>, <span title="Int(5)" class="int">5</span>, <span title="Int(6)" class="int">6</span>, <span title="Int(7)" class="int">7</span>, <span title="Int(8)" class="int">8</span>, <span title="Int(9)" class="int">9</span>, <span title="Int(10)" class="int">10</span>, <span title="Int(12)" class="int">12</span>, <span title="Int(13)" class="int">13</span>, <span title="Int(14)" class="int">14</span>, <span title="Int(15)" class="int">15</span>, <span title="Int(17)" class="int">17</span>, <span title="Int(19)" class="int">19</span>, <span title="Int(21)" class="int">21</span>, <span title="Int(23)" class="int">23</span>, <span title="Int(25)" class="int">25</span>, <span title="Int(28)" class="int">28</span>,
          <span title="Int(31)" class="int">31</span>, <span title="Int(34)" class="int">34</span>, <span title="Int(37)" class="int">37</span>, <span title="Int(41)" class="int">41</span>, <span title="Int(45)" class="int">45</span>, <span title="Int(50)" class="int">50</span>, <span title="Int(55)" class="int">55</span>, <span title="Int(61)" class="int">61</span>, <span title="Int(67)" class="int">67</span>, <span title="Int(74)" class="int">74</span>, <span title="Int(82)" class="int">82</span>, <span title="Int(91)" class="int">91</span>, <span title="Int(100)" class="int">100</span>, <span title="Int(111)" class="int">111</span>, <span title="Int(122)" class="int">122</span>, <span title="Int(135)" class="int">135</span>,
          <span title="Int(150)" class="int">150</span>, <span title="Int(165)" class="int">165</span>, <span title="Int(183)" class="int">183</span>, <span title="Int(202)" class="int">202</span>, <span title="Int(223)" class="int">223</span>, <span title="Int(246)" class="int">246</span>, <span title="Int(272)" class="int">272</span>, <span title="Int(301)" class="int">301</span>, <span title="Int(332)" class="int">332</span>, <span title="Int(367)" class="int">367</span>, <span title="Int(406)" class="int">406</span>, <span title="Int(449)" class="int">449</span>, <span title="Int(496)" class="int">496</span>, <span title="Int(548)" class="int">548</span>,
          <span title="Int(606)" class="int">606</span>, <span title="Int(669)" class="int">669</span>, <span title="Int(740)" class="int">740</span>, <span title="Int(817)" class="int">817</span>, <span title="Int(903)" class="int">903</span>, <span title="Int(999)" class="int">999</span>, <span title="Int(1104)" class="int">1104</span>, <span title="Int(1220)" class="int">1220</span>, <span title="Int(1348)" class="int">1348</span>, <span title="Int(1490)" class="int">1490</span>, <span title="Int(1647)" class="int">1647</span>, <span title="Int(1820)" class="int">1820</span>, <span title="Int(2011)" class="int">2011</span>,
          <span title="Int(2223)" class="int">2223</span>, <span title="Int(2457)" class="int">2457</span>, <span title="Int(2716)" class="int">2716</span>, <span title="Int(3001)" class="int">3001</span>, <span title="Int(3317)" class="int">3317</span>, <span title="Int(3666)" class="int">3666</span>, <span title="Int(4052)" class="int">4052</span>, <span title="Int(4479)" class="int">4479</span>, <span title="Int(4950)" class="int">4950</span>, <span title="Int(5471)" class="int">5471</span>, <span title="Int(6047)" class="int">6047</span>, <span title="Int(6684)" class="int">6684</span>,
          <span title="Int(7387)" class="int">7387</span>, <span title="Int(8165)" class="int">8165</span>, <span title="Int(9024)" class="int">9024</span>, <span title="Int(9974)" class="int">9974</span>, <span title="Int(11024)" class="int">11024</span>, <span title="Int(12184)" class="int">12184</span>, <span title="Int(13467)" class="int">13467</span>, <span title="Int(14884)" class="int">14884</span>, <span title="Int(16451)" class="int">16451</span>, <span title="Int(18182)" class="int">18182</span>, <span title="Int(20096)" class="int">20096</span>,
          <span title="Int(22212)" class="int">22212</span>, <span title="Int(24550)" class="int">24550</span>, <span title="Int(27134)" class="int">27134</span>, <span title="Int(29990)" class="int">29990</span>, <span title="Int(33147)" class="int">33147</span>, <span title="Int(36636)" class="int">36636</span>, <span title="Int(40492)" class="int">40492</span>, <span title="Int(44754)" class="int">44754</span>, <span title="Int(49465)" class="int">49465</span>, <span title="Int(54672)" class="int">54672</span>,
          <span title="Int(60427)" class="int">60427</span>, <span title="Int(66787)" class="int">66787</span>, <span title="Int(73818)" class="int">73818</span>, <span title="Int(81588)" class="int">81588</span>, <span title="Int(90176)" class="int">90176</span>, <span title="Int(99668)" class="int">99668</span>, <span title="Int(110160)" class="int">110160</span>, <span title="Int(121755)" class="int">121755</span>, <span title="Int(134572)" class="int">134572</span>,
          <span title="Int(148737)" class="int">148737</span>, <span title="Int(164393)" class="int">164393</span>, <span title="Int(181698)" class="int">181698</span>, <span title="Int(200824)" class="int">200824</span>, <span title="Int(221963)" class="int">221963</span>, <span title="Int(245328)" class="int">245328</span>, <span title="Int(271152)" class="int">271152</span>, <span title="Int(299694)" class="int">299694</span>, <span title="Int(331240)" class="int">331240</span>,
          <span title="Int(366108)" class="int">366108</span>, <span title="Int(404645)" class="int">404645</span>, <span title="Int(447240)" class="int">447240</span>, <span title="Int(494317)" class="int">494317</span>, <span title="Int(546351)" class="int">546351</span>, <span title="Int(603861)" class="int">603861</span>, <span title="Int(667426)" class="int">667426</span>, <span title="Int(737681)" class="int">737681</span>, <span title="Int(815331)" class="int">815331</span>,
          <span title="Int(901156)" class="int">901156</span>, <span title="Int(996014)" class="int">996014</span>, <span title="Int(1100858)" class="int">1100858</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="Int" id="39885">bucketOffsetSize</a> = <a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="=&gt; Int">size</span>

  <span class="keyword">def</span> <a title="(key: Int)Int" id="39887">bucketIndex</a><span class="delimiter">(</span><a title="Int" id="40908">key</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#39889" title="(key: Int)Int">binarySearch</a><span class="delimiter">(</span><a href="#40908" title="Int">key</a><span class="delimiter">)</span>

  @tailrec
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(array: Array[Int],key: Int,low: Int,high: Int)Int" id="39888">binarySearch</a><span class="delimiter">(</span><a title="Array[Int]" id="40915">array</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Int" id="40916">key</a>: <span title="Int">Int</span>, <a title="Int" id="40917">low</a>: <span title="Int">Int</span>, <a title="Int" id="40918">high</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#40917" title="(x$1: Int)Boolean">low</a> &gt; <a href="#40918" title="Int">high</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#40917" title="Int">low</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="40928">mid</a> = <span title="(x$1: Int)Int" class="delimiter">(</span><a href="#40917" title="(x$1: Int)Int">low</a> <span title="(x$1: Int)Int">+</span> <a href="#40918" title="Int">high</a> + <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> &gt;&gt; <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="Int" id="40929">midValue</a> = <a href="#40915" title="(i: Int)Int">array</a><span class="delimiter">(</span><a href="#40928" title="Int">mid</a><span class="delimiter">)</span>
      <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#40929" title="(x$1: Int)Boolean">midValue</a> &lt; <a href="#40916" title="Int">key</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#39888" title="(array: Array[Int],key: Int,low: Int,high: Int)Int">binarySearch</a><span class="delimiter">(</span><a href="#40915" title="Array[Int]">array</a>, <a href="#40916" title="Int">key</a>, <a href="#40928" title="(x$1: Int)Int">mid</a> + <span title="Int(1)" class="int">1</span>, <a href="#40918" title="Int">high</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#40929" title="(x$1: Int)Boolean">midValue</a> &gt; <a href="#40916" title="Int">key</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#39888" title="(array: Array[Int],key: Int,low: Int,high: Int)Int">binarySearch</a><span class="delimiter">(</span><a href="#40915" title="Array[Int]">array</a>, <a href="#40916" title="Int">key</a>, <a href="#40917" title="Int">low</a>, <a href="#40928" title="(x$1: Int)Int">mid</a> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <span class="comment">// exactly equal to this bucket's value. but the value is an exclusive max, so bump it up.</span>
        <a href="#40928" title="(x$1: Int)Int">mid</a> + <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: Int)Int" id="39889">binarySearch</a><span class="delimiter">(</span><a title="Int" id="40913">key</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <a href="#39888" title="(array: Array[Int],key: Int,low: Int,high: Int)Int">binarySearch</a><span class="delimiter">(</span><a href="#39883" title="=&gt; Array[Int]">BUCKET_OFFSETS</a>, <a href="#40913" title="Int">key</a>, <span title="Int(0)" class="int">0</span>, <a href="#39883" title="=&gt; Array[Int]">BUCKET_OFFSETS</a>.<span title="(x$1: Int)Int">length</span> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(values: Int*)com.twitter.ostrich.stats.Histogram" id="39890">apply</a><span class="delimiter">(</span><a title="Int*" id="39891">values</a>: <span title="Int*">Int</span>*<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.Histogram" id="39894">h</a> = <span title="com.twitter.ostrich.stats.Histogram" class="keyword">new</span> <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#39891" title="Int*">values</a>.<span title="(f: (Int) =&gt; Long)Unit">foreach</span> <span class="delimiter">{</span> <a href="#39894" title="com.twitter.ostrich.stats.Histogram">h</a>.<a href="#34183" title="(n: Int)Long">add</a><span class="delimiter">(</span><a href="#39908" title="Int">_</a><span class="delimiter">)</span> <span class="delimiter">}</span>
    <a href="#39894" title="com.twitter.ostrich.stats.Histogram">h</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class Histogram extends java.lang.Object with ScalaObject" id="9323">Histogram</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="Int" id="34172">numBuckets</a> = <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="=&gt; Array[Int]">BUCKET_OFFSETS</a>.<span title="(x$1: Int)Int">length</span> + <span title="Int(1)" class="int">1</span>
  <span class="keyword">val</span> <a title="Array[Long]" id="34174">buckets</a> = <span title="Array[Long]" class="keyword">new</span> <span title="Array[Long]">Array</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">(</span><a href="#34172" title="=&gt; Int">numBuckets</a><span class="delimiter">)</span>
  <span class="keyword">var</span> <a title="Long" id="34177">count</a> = <span title="Long(0L)" class="long">0L</span>
  <span class="keyword">var</span> <a title="Long" id="34180">sum</a> = <span title="Long(0L)" class="long">0L</span>

  <span class="comment">/**
   * Adds a value directly to a bucket in a histogram. Can be used for
   * performance reasons when modifying the histogram object from within a
   * synchronized block.
   *
   * @param index the index of the bucket. Should be obtained from a value by
   * calling Histogram.bucketIndex(n) on the value.
   */</span>
  <span class="keyword">def</span> <a title="(index: Int)Unit" id="34182">addToBucket</a><span class="delimiter">(</span><a title="Int" id="41001">index</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#34174" title="(i: Int,x: Long)Unit">buckets</a><span title="(x$1: Int)Long" class="delimiter">(</span><a href="#41001" title="Int">index</a><span class="delimiter">)</span> += <span title="Int(1)" class="int">1</span>
    <a href="#34177" title="(x$1: Long)Unit">count</a> += <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(n: Int)Long" id="34183">add</a><span class="delimiter">(</span><a title="Int" id="39909">n</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <a href="#34182" title="(index: Int)Unit">addToBucket</a><span class="delimiter">(</span><a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39887" title="(key: Int)Int">bucketIndex</a><span class="delimiter">(</span><a href="#39909" title="Int">n</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#34180" title="(x$1: Long)Unit">sum</a> += <a href="#39909" title="Int">n</a>
    <a href="#34177" title="=&gt; Long">count</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="34184">clear</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="41084">i</a> &lt;- <span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> <span title="(f: (Int) =&gt; Unit)Unit">until</span> <a href="#34172" title="=&gt; Int">numBuckets</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#34174" title="(i: Int,x: Long)Unit">buckets</a><span class="delimiter">(</span><a href="#41084" title="Int">i</a><span class="delimiter">)</span> = <span title="Long(0L)" class="int">0</span>
    <span class="delimiter">}</span>
    <a href="#34177" title="(x$1: Long)Unit">count</a> = <span title="Long(0L)" class="int">0</span>
    <a href="#34180" title="(x$1: Long)Unit">sum</a> = <span title="Long(0L)" class="int">0</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(reset: Boolean)List[Long]" id="34185">get</a><span class="delimiter">(</span><a title="Boolean" id="41090">reset</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[Long]" id="41093">rv</a> = <a href="#34174" title="implicit scala.Predef.longArrayOps : (xs: Array[Long])scala.collection.mutable.ArrayOps[Long]">buckets</a>.<span title="=&gt; List[Long]">toList</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41090" title="Boolean">reset</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#34184" title="()Unit">clear</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#41093" title="List[Long]">rv</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Percentile within 5%, but:
   *   0 if no values
   *   Int.MaxValue if percentile is out of range
   */</span>
  <span class="keyword">def</span> <a title="(percentile: Double)Int" id="34186">getPercentile</a><span class="delimiter">(</span><a title="Double" id="34196">percentile</a>: <span title="Double">Double</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34196" title="(x$1: Double)Boolean">percentile</a> == <span title="Double(0.0)" class="double">0.0</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#34188" title="=&gt; Int">minimum</a>
    <span class="keyword">var</span> <a title="Long" id="41242">total</a> = <span title="Long(0L)" class="long">0L</span>
    <span class="keyword">var</span> <a title="Int" id="41243">index</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#41242" title="(x$1: Double)Boolean">total</a> &lt; <a href="#34196" title="(x$1: Long)Double">percentile</a> * <a href="#34177" title="=&gt; Long">count</a><span class="delimiter">)</span> <a href="#41244" title="()Unit" class="delimiter">{</a>
      <a href="#41242" title="Long">total</a> += <a href="#34174" title="(i: Int)Long">buckets</a><span class="delimiter">(</span><a href="#41243" title="Int">index</a><span class="delimiter">)</span>
      <a href="#41243" title="Int">index</a> += <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#41243" title="(x$1: Int)Boolean">index</a> == <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#41243" title="(x$1: Int)Int">index</a> <span title="(x$1: Int)Boolean">-</span> <span title="Int(1)" class="int">1</span> &gt;= <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      Int.<span title="Int(2147483647)">MaxValue</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#34189" title="(index: Int)Int">midpoint</a><span class="delimiter">(</span><a href="#41243" title="(x$1: Int)Int">index</a> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Maximum value within 5%, but:
   *    0 if no values
   *    Int.MaxValue if any value is infinity
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Int" id="34187">maximum</a>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#34174" title="(i: Int)Long">buckets</a><span title="(x$1: Int)Boolean" class="delimiter">(</span><a href="#34174" title="implicit scala.Predef.longArrayOps : (xs: Array[Long])scala.collection.mutable.ArrayOps[Long]">buckets</a>.<span title="(x$1: Int)Int">size</span> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> &gt; <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// Infinity bucket has a value</span>
      Int.<span title="Int(2147483647)">MaxValue</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#34177" title="(x$1: Int)Boolean">count</a> == <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// No values</span>
      <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Int" id="41785">index</a> = <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="(x$1: Int)Int">size</span> - <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#41785" title="(x$1: Int)Boolean">index</a> <span title="(x$1: Boolean)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span> &amp;&amp; <a href="#34174" title="(i: Int)Long">buckets</a><span title="(x$1: Int)Boolean" class="delimiter">(</span><a href="#41785" title="Int">index</a><span class="delimiter">)</span> == <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#41785" title="Int">index</a> <a href="#41786" title="()Unit">-=</a> <span title="Int(1)" class="int">1</span>
      <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#41785" title="(x$1: Int)Boolean">index</a> &lt; <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Int(0)" class="int">0</span>
      <span class="keyword">else</span>
        <a href="#34189" title="(index: Int)Int">midpoint</a><span class="delimiter">(</span><a href="#41785" title="Int">index</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Minimum value within 5%, but:
   *    0 if no values
   *    Int.MaxValue if all values are infinity
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Int" id="34188">minimum</a>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#34177" title="(x$1: Int)Boolean">count</a> == <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Int" id="42059">index</a> = <span title="Int(0)" class="int">0</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#42059" title="(x$1: Int)Boolean">index</a> <span title="(x$1: Boolean)Boolean">&lt;</span> <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="=&gt; Int">size</span> &amp;&amp; <a href="#34174" title="(i: Int)Long">buckets</a><span title="(x$1: Int)Boolean" class="delimiter">(</span><a href="#42059" title="Int">index</a><span class="delimiter">)</span> == <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#42059" title="Int">index</a> <a href="#42060" title="()Unit">+=</a> <span title="Int(1)" class="int">1</span>
      <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#42059" title="(x$1: Int)Boolean">index</a> &gt;= <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
        Int.<span title="Int(2147483647)">MaxValue</span>
      <span class="keyword">else</span>
        <a href="#34189" title="(index: Int)Int">midpoint</a><span class="delimiter">(</span><a href="#42059" title="Int">index</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// Get midpoint of bucket</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(index: Int)Int" id="34189">midpoint</a><span class="delimiter">(</span><a title="Int" id="41530">index</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#41530" title="(x$1: Int)Boolean">index</a> == <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span title="Int(0)" class="int">0</span>
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#41530" title="(x$1: Int)Int">index</a> <span title="(x$1: Int)Boolean">-</span> <span title="Int(1)" class="int">1</span> &gt;= <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
      Int.<span title="Int(2147483647)">MaxValue</span>
    <span class="keyword">else</span>
      <span title="(x$1: Int)Int" class="delimiter">(</span><a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="(i: Int)Int">BUCKET_OFFSETS</a><span title="(x$1: Int)Int" class="delimiter">(</span><a href="#41530" title="(x$1: Int)Int">index</a> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x$1: Int)Int">+</span> <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="(i: Int)Int">BUCKET_OFFSETS</a><span class="delimiter">(</span><a href="#41530" title="Int">index</a><span class="delimiter">)</span> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> / <span title="Int(2)" class="int">2</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(other: com.twitter.ostrich.stats.Histogram)Unit" id="34190">merge</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.Histogram" id="42819">other</a>: <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42819" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34177" title="(x$1: Int)Boolean">count</a> &gt; <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="42858">i</a> &lt;- <span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> <span title="(f: (Int) =&gt; Unit)Unit">until</span> <a href="#34172" title="=&gt; Int">numBuckets</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#34174" title="(i: Int,x: Long)Unit">buckets</a><span title="(x$1: Long)Long" class="delimiter">(</span><a href="#42858" title="Int">i</a><span class="delimiter">)</span> += <a href="#42819" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34174" title="(i: Int)Long">buckets</a><span class="delimiter">(</span><a href="#42858" title="Int">i</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#34177" title="(x$1: Long)Unit">count</a> += <a href="#42819" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34177" title="=&gt; Long">count</a>
      <a href="#34180" title="(x$1: Long)Unit">sum</a> += <a href="#42819" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34180" title="=&gt; Long">sum</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(other: com.twitter.ostrich.stats.Histogram)com.twitter.ostrich.stats.Histogram" id="34191">-</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.Histogram" id="39974">other</a>: <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a><span class="delimiter">)</span>: <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.Histogram" id="42901">rv</a> = <span title="com.twitter.ostrich.stats.Histogram" class="keyword">new</span> <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#42901" title="com.twitter.ostrich.stats.Histogram">rv</a>.<a href="#34177" title="(x$1: Long)Unit">count</a> = <a href="#34177" title="(x$1: Long)Long">count</a> - <a href="#39974" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34177" title="=&gt; Long">count</a>
    <a href="#42901" title="com.twitter.ostrich.stats.Histogram">rv</a>.<a href="#34180" title="(x$1: Long)Unit">sum</a> = <a href="#34180" title="(x$1: Long)Long">sum</a> - <a href="#39974" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34180" title="=&gt; Long">sum</a>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="42947">i</a> &lt;- <span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> <span title="(f: (Int) =&gt; Unit)Unit">until</span> <a href="#34172" title="=&gt; Int">numBuckets</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#42901" title="com.twitter.ostrich.stats.Histogram">rv</a>.<a href="#34174" title="(i: Int,x: Long)Unit">buckets</a><span class="delimiter">(</span><a href="#42947" title="Int">i</a><span class="delimiter">)</span> = <a href="#34174" title="(i: Int)Long">buckets</a><span title="(x$1: Long)Long" class="delimiter">(</span><a href="#42947" title="Int">i</a><span class="delimiter">)</span> - <a href="#39974" title="com.twitter.ostrich.stats.Histogram">other</a>.<a href="#34174" title="(i: Int)Long">buckets</a><span class="delimiter">(</span><a href="#42947" title="Int">i</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#42901" title="com.twitter.ostrich.stats.Histogram">rv</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get an immutable snapshot of this histogram.
   */</span>
  <span class="keyword">def</span> <a title="()com.twitter.ostrich.stats.Distribution" id="34192">apply</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="Distribution.scala.html#9314" title="com.twitter.ostrich.stats.Distribution">Distribution</a> = <span title="com.twitter.ostrich.stats.Distribution" class="keyword">new</span> <a href="Distribution.scala.html#9314" title="com.twitter.ostrich.stats.Distribution">Distribution</a><span class="delimiter">(</span><a href="#34195" title="()com.twitter.ostrich.stats.Histogram">clone</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(other: Any)Boolean" id="34193">equals</a><span class="delimiter">(</span><a title="Any" id="42966">other</a>: <span title="Any">Any</span><span class="delimiter">)</span> = <a href="#42966" title="Any">other</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span title="Boolean" class="keyword">case</span> <a title="com.twitter.ostrich.stats.Histogram" id="42969">h</a>: <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a> =&gt;
      <a href="#42969" title="com.twitter.ostrich.stats.Histogram">h</a>.<a href="#34177" title="(x$1: Long)Boolean">count</a> <span title="(x$1: Boolean)Boolean">==</span> <a href="#34177" title="=&gt; Long">count</a> <span title="(x$1: Boolean)Boolean">&amp;&amp;</span> <a href="#42969" title="com.twitter.ostrich.stats.Histogram">h</a>.<a href="#34180" title="(x$1: Long)Boolean">sum</a> == <a href="#34180" title="=&gt; Long">sum</a> &amp;&amp; <a href="#42969" title="com.twitter.ostrich.stats.Histogram">h</a>.<a href="#34174" title="implicit scala.Predef.longArrayOps : (xs: Array[Long])scala.collection.mutable.ArrayOps[Long]">buckets</a>.<span title="=&gt; scala.collection.immutable.Range">indices</span>.<span title="(p: (Int) =&gt; Boolean)Boolean">forall</span> <span class="delimiter">{</span> <a title="Int" id="43127">i</a> =&gt; <a href="#42969" title="com.twitter.ostrich.stats.Histogram">h</a>.<a href="#34174" title="(i: Int)Long">buckets</a><span title="(x$1: Long)Boolean" class="delimiter">(</span><a href="#43127" title="Int">i</a><span class="delimiter">)</span> == <a href="#34174" title="(i: Int)Long">buckets</a><span class="delimiter">(</span><a href="#43127" title="Int">i</a><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span title="Boolean(false)" class="keyword">case</span> _ =&gt; <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="34194">toString</a> = <span class="delimiter">{</span>
    <span title="(x$1: Any)java.lang.String" class="string">&quot;&lt;Histogram count=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#34177" title="=&gt; Long">count</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; sum=&quot;)" class="string">&quot; sum=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#34180" title="=&gt; Long">sum</a> <span title="(x$1: Any)java.lang.String">+</span>
      <a href="#34174" title="implicit scala.Predef.longArrayOps : (xs: Array[Long])scala.collection.mutable.ArrayOps[Long]">buckets</a>.<span title="=&gt; scala.collection.immutable.Range">indices</span>.<span title="(f: (Int) =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],java.lang.String,scala.collection.immutable.IndexedSeq[java.lang.String]])scala.collection.immutable.IndexedSeq[java.lang.String]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,java.lang.String,scala.collection.immutable.IndexedSeq[java.lang.String]]" class="delimiter">{</span> <a title="Int" id="43290">i</a> =&gt;
        <span title="(other: String)java.lang.String" class="delimiter">(</span><span title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd" class="keyword">if</span> <span class="delimiter">(</span><a href="#43290" title="(x$1: Int)Boolean">i</a> &lt; <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]">BUCKET_OFFSETS</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#9321" title="object com.twitter.ostrich.stats.Histogram">Histogram</a>.<a href="#39883" title="(i: Int)Int">BUCKET_OFFSETS</a><span class="delimiter">(</span><a href="#43290" title="Int">i</a><span class="delimiter">)</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;inf&quot;)" class="string">&quot;inf&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span>
        <span title="java.lang.String(&quot;=&quot;)" class="string">&quot;=&quot;</span> + <a href="#34174" title="(i: Int)Long">buckets</a><span class="delimiter">(</span><a href="#43290" title="Int">i</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>.<span title="(start: String,sep: String,end: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span>, <span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span> +
      <span title="java.lang.String(&quot;&gt;&quot;)" class="string">&quot;&gt;&quot;</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()com.twitter.ostrich.stats.Histogram" id="34195">clone</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.Histogram" id="43710">histogram</a> = <span title="com.twitter.ostrich.stats.Histogram" class="keyword">new</span> <a href="#9323" title="com.twitter.ostrich.stats.Histogram">Histogram</a>
    <a href="#43710" title="com.twitter.ostrich.stats.Histogram">histogram</a>.<a href="#34190" title="(other: com.twitter.ostrich.stats.Histogram)Unit">merge</a><span class="delimiter">(</span><a href="#9323" title="com.twitter.ostrich.stats.Histogram" class="keyword">this</a><span class="delimiter">)</span>
    <a href="#43710" title="com.twitter.ostrich.stats.Histogram">histogram</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>