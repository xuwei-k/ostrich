<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>StatsListener.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2011 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> com.twitter.ostrich
<span class="keyword">package</span> stats

<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> scala.collection.<span class="delimiter">{</span>JavaConversions, Map, mutable, immutable<span class="delimiter">}</span>
<span class="keyword">import</span> scala.util.matching.Regex
<span class="keyword">import</span> com.twitter.conversions.<span title="object com.twitter.conversions.time">time</span>._
<span class="keyword">import</span> com.twitter.json.<span class="delimiter">{</span>Json, JsonSerializable<span class="delimiter">}</span>
<span class="keyword">import</span> com.twitter.util.Duration
<span class="keyword">import</span> admin.<span class="delimiter">{</span>ServiceTracker, PeriodicBackgroundProcess<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object com.twitter.ostrich.stats.StatsListener" id="9375">StatsListener</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]" id="28241">listeners</a> = <span title="()java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]">ConcurrentHashMap</span><span class="delimiter">[</span><span class="delimiter">(</span>String, StatsCollection<span class="delimiter">)</span>, StatsListener<span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="()Unit" id="28243">clearAll</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#28241" title="=&gt; java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]">listeners</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(id: String,collection: com.twitter.ostrich.stats.StatsCollection,listener: =&gt; com.twitter.ostrich.stats.StatsListener)com.twitter.ostrich.stats.StatsListener" id="28244">getOrRegister</a><span class="delimiter">(</span><a title="String" id="48057">id</a>: <span title="String">String</span>, <a title="com.twitter.ostrich.stats.StatsCollection" id="48058">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>, <a title="=&gt; com.twitter.ostrich.stats.StatsListener" id="48059">listener</a>: =&gt; StatsListener<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(String, com.twitter.ostrich.stats.StatsCollection)" id="48062">key</a> = <span title="(_1: String,_2: com.twitter.ostrich.stats.StatsCollection)(String, com.twitter.ostrich.stats.StatsCollection)" class="delimiter">(</span><a href="#48057" title="String">id</a>, <a href="#48058" title="com.twitter.ostrich.stats.StatsCollection">collection</a><span class="delimiter">)</span>
    <span title="(x: com.twitter.ostrich.stats.StatsListener)Option[com.twitter.ostrich.stats.StatsListener]">Option</span> <span class="delimiter">{</span>
      <a href="#28241" title="=&gt; java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]">listeners</a>.<span title="(x$1: Any)com.twitter.ostrich.stats.StatsListener">get</span><span class="delimiter">(</span><a href="#48062" title="(String, com.twitter.ostrich.stats.StatsCollection)">key</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(default: =&gt; com.twitter.ostrich.stats.StatsListener)com.twitter.ostrich.stats.StatsListener">getOrElse</span> <span class="delimiter">{</span>
      <a href="#28241" title="=&gt; java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]">listeners</a>.<span title="(x$1: (String, com.twitter.ostrich.stats.StatsCollection),x$2: com.twitter.ostrich.stats.StatsListener)com.twitter.ostrich.stats.StatsListener">putIfAbsent</span><span class="delimiter">(</span><a href="#48062" title="(String, com.twitter.ostrich.stats.StatsCollection)">key</a>, <a href="#48059" title="=&gt; com.twitter.ostrich.stats.StatsListener">listener</a><span class="delimiter">)</span>
      <a href="#28241" title="=&gt; java.util.concurrent.ConcurrentHashMap[(String, com.twitter.ostrich.stats.StatsCollection),com.twitter.ostrich.stats.StatsListener]">listeners</a>.<span title="(x$1: Any)com.twitter.ostrich.stats.StatsListener">get</span><span class="delimiter">(</span><a href="#48062" title="(String, com.twitter.ostrich.stats.StatsCollection)">key</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get a StatsListener that's attached to a specified stats collection tracked by name,
   * creating it if it doesn't already exist.
   */</span>
  <span class="keyword">def</span> <a title="(name: String,collection: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsListener" id="28245">apply</a><span class="delimiter">(</span><a title="String" id="28525">name</a>: <span title="String">String</span>, <a title="com.twitter.ostrich.stats.StatsCollection" id="28526">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a><span class="delimiter">)</span>: <a href="#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a> = <span class="delimiter">{</span>
    <a href="#28244" title="(id: String,collection: com.twitter.ostrich.stats.StatsCollection,listener: =&gt; com.twitter.ostrich.stats.StatsListener)com.twitter.ostrich.stats.StatsListener">getOrRegister</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;ns:%s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#28525" title="String">name</a><span class="delimiter">)</span>, <a href="#28526" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#28575" title="(collection: com.twitter.ostrich.stats.StatsCollection,startClean: Boolean)com.twitter.ostrich.stats.StatsListener" class="keyword">new</a> <a href="#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a><span class="delimiter">(</span><a href="#28526" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get a StatsListener that's attached to a specified stats collection and tracks periodic stats
   * over the given duration, creating it if it doesn't already exist.
   */</span>
  <span class="keyword">def</span> <a title="(period: com.twitter.util.Duration,collection: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsListener" id="28246">apply</a><span class="delimiter">(</span><a title="com.twitter.util.Duration" id="28522">period</a>: <span title="com.twitter.util.Duration">Duration</span>, <a title="com.twitter.ostrich.stats.StatsCollection" id="28523">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a><span class="delimiter">)</span>: <a href="#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a> = <span class="delimiter">{</span>
    <a href="#28244" title="(id: String,collection: com.twitter.ostrich.stats.StatsCollection,listener: =&gt; com.twitter.ostrich.stats.StatsListener)com.twitter.ostrich.stats.StatsListener">getOrRegister</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;period:%d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#28522" title="com.twitter.util.Duration">period</a>.<span title="=&gt; Long">inMillis</span><span class="delimiter">)</span>, <a href="#28523" title="com.twitter.ostrich.stats.StatsCollection">collection</a>,
      <a href="#48130" title="(collection: com.twitter.ostrich.stats.StatsCollection,period: com.twitter.util.Duration,startClean: Boolean)com.twitter.ostrich.stats.LatchedStatsListener" class="keyword">new</a> <a href="#9378" title="com.twitter.ostrich.stats.LatchedStatsListener">LatchedStatsListener</a><span class="delimiter">(</span><a href="#28523" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#28522" title="com.twitter.util.Duration">period</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get a StatsListener that's attached to a specified stats collection and tracks periodic stats
   * over the given duration, creating it if it doesn't already exist.
   */</span>
  <span class="keyword">def</span> <a title="(period: com.twitter.util.Duration,collection: com.twitter.ostrich.stats.StatsCollection,filters: List[scala.util.matching.Regex])com.twitter.ostrich.stats.StatsListener" id="28247">apply</a><span class="delimiter">(</span><a title="com.twitter.util.Duration" id="28253">period</a>: <span title="com.twitter.util.Duration">Duration</span>, <a title="com.twitter.ostrich.stats.StatsCollection" id="28254">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>, <a title="List[scala.util.matching.Regex]" id="28255">filters</a>: <span title="List[scala.util.matching.Regex]">List</span><span class="delimiter">[</span>Regex<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a> = <span class="delimiter">{</span>
    <a href="#28244" title="(id: String,collection: com.twitter.ostrich.stats.StatsCollection,listener: =&gt; com.twitter.ostrich.stats.StatsListener)com.twitter.ostrich.stats.StatsListener">getOrRegister</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;period:%d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#28253" title="com.twitter.util.Duration">period</a>.<span title="=&gt; Long">inMillis</span><span class="delimiter">)</span>, <a href="#28254" title="com.twitter.ostrich.stats.StatsCollection">collection</a>,
      <span title="com.twitter.ostrich.stats.LatchedStatsListener" class="keyword">new</span> <a href="#9378" title="com.twitter.ostrich.stats.LatchedStatsListener">LatchedStatsListener</a><span class="delimiter">(</span><a href="#28254" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#28253" title="com.twitter.util.Duration">period</a>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#28255" title="List[scala.util.matching.Regex]">filters</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get a StatsListener that's attached to the global stats collection and tracks periodic stats
   * over the given duration, creating it if it doesn't already exist.
   */</span>
  <span class="keyword">def</span> <a title="(period: com.twitter.util.Duration)com.twitter.ostrich.stats.StatsListener" id="28248">apply</a><span class="delimiter">(</span><a title="com.twitter.util.Duration" id="28251">period</a>: <span title="com.twitter.util.Duration">Duration</span><span class="delimiter">)</span>: <a href="#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a> = <a href="#28246" title="(period: com.twitter.util.Duration,collection: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsListener">apply</a><span class="delimiter">(</span><a href="#28251" title="com.twitter.util.Duration">period</a>, <a href="Stats.scala.html#9346" title="object com.twitter.ostrich.stats.Stats">Stats</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Attaches to a StatsCollection and reports on all the counters, metrics, gauges, and labels.
 * Each report resets state, so counters are reported as deltas, and metrics distributions are
 * only tracked since the last report.
 */</span>
<span class="keyword">class</span> <a title="class StatsListener extends java.lang.Object with ScalaObject" id="9377">StatsListener</a><span title="ScalaObject" class="delimiter">(</span><a title="com.twitter.ostrich.stats.StatsCollection" id="34021">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>, <a title="Boolean" id="34022">startClean</a>: <span title="Boolean">Boolean</span>, <a title="List[scala.util.matching.Regex]" id="34023">filters</a>: <span title="List[scala.util.matching.Regex]">List</span><span class="delimiter">[</span>Regex<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(collection: com.twitter.ostrich.stats.StatsCollection,startClean: Boolean)com.twitter.ostrich.stats.StatsListener" id="28575" class="keyword">this</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.StatsCollection" id="34019">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>, <a title="Boolean" id="34020">startClean</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> = <a href="#9377" title="StatsListener.this.type" class="keyword">this</a><span class="delimiter">(</span><a href="#34019" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#34020" title="Boolean">startClean</a>, <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(collection: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsListener" id="28576" class="keyword">this</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.StatsCollection" id="34018">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a><span class="delimiter">)</span> = <a href="#9377" title="StatsListener.this.type" class="keyword">this</a><span class="delimiter">(</span><a href="#34018" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <span title="Boolean(true)" class="keyword">true</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,Long]" id="28577">lastCounterMap</a> = <span title="scala.collection.mutable.HashMap[String,Long]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,Long]">HashMap</span><span class="delimiter">[</span>String, Long<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]" id="28579">lastMetricMap</a> = <span title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">HashMap</span><span class="delimiter">[</span>String, Distribution<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.util.matching.Regex" id="28581">filterRegex</a> = <a href="#34023" title="List[scala.util.matching.Regex]">filters</a>.<span title="(start: String,sep: String,end: String)String">mkString</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="delimiter">(</span><span title="java.lang.String(&quot;(&quot;)" class="string">&quot;(&quot;</span>, <span title="java.lang.String(&quot;)|(&quot;)" class="string">&quot;)|(&quot;</span>, <span title="java.lang.String(&quot;)&quot;)" class="string">&quot;)&quot;</span><span class="delimiter">)</span>.<span title="=&gt; scala.util.matching.Regex">r</span>

  <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24021" title="(listener: com.twitter.ostrich.stats.StatsListener)Unit">addListener</a><span class="delimiter">(</span><a href="#9377" title="com.twitter.ostrich.stats.StatsListener" class="keyword">this</a><span class="delimiter">)</span>
  <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34022" title="Boolean">startClean</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24033" title="()scala.collection.mutable.HashMap[String,Long]">getCounters</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(f: ((String, Long)) =&gt; Unit)Unit">foreach</span> <a href="#48266" title="Unit" class="delimiter">{</a> <span title="Unit" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="48269">key</a>, <a title="Long" id="48270">value</a><span class="delimiter">)</span> =&gt;
      <a href="#28577" title="(key: String,value: Long)Unit">lastCounterMap</a><span class="delimiter">(</span><a href="#48269" title="String">key</a><span class="delimiter">)</span> = <a href="#48270" title="Long">value</a>
    <span class="delimiter">}</span>
    <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24034" title="()scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">getMetrics</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(f: ((String, com.twitter.ostrich.stats.Distribution)) =&gt; Unit)Unit">foreach</span> <a href="#48310" title="Unit" class="delimiter">{</a> <span title="Unit" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="48313">key</a>, <a title="com.twitter.ostrich.stats.Distribution" id="48314">value</a><span class="delimiter">)</span> =&gt;
      <a href="#28579" title="(key: String,value: com.twitter.ostrich.stats.Distribution)Unit">lastMetricMap</a><span class="delimiter">(</span><a href="#48313" title="String">key</a><span class="delimiter">)</span> = <a href="#48314" title="com.twitter.ostrich.stats.Distribution">value</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()scala.collection.Map[String,Long]" id="28583">getCounters</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="scala.collection.Map[String,Long]">Map</span><span class="delimiter">[</span>String, Long<span class="delimiter">]</span> = <a href="#9377" title="(x$1: scala.collection.mutable.HashMap[String,Long])scala.collection.mutable.HashMap[String,Long]">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,Long]" id="48326">deltas</a> = <span title="scala.collection.mutable.HashMap[String,Long]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,Long]">HashMap</span><span class="delimiter">[</span>String, Long<span class="delimiter">]</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="48360">key</a>, <a title="Long" id="48361">newValue</a><span class="delimiter">)</span> &lt;- <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24033" title="()scala.collection.mutable.HashMap[String,Long]">getCounters</a><a href="#48331" title="(f: ((String, Long)) =&gt; Unit)Unit" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#48326" title="(key: String,value: Long)Unit">deltas</a><span class="delimiter">(</span><a href="#48360" title="String">key</a><span class="delimiter">)</span> = <a href="Stats.scala.html#9346" title="object com.twitter.ostrich.stats.Stats">Stats</a>.<a href="Stats.scala.html#24098" title="(oldValue: Long,newValue: Long)Long">delta</a><span class="delimiter">(</span><a href="#28577" title="=&gt; scala.collection.mutable.HashMap[String,Long]">lastCounterMap</a>.<span title="(key: String,default: =&gt; Long)Long">getOrElse</span><span class="delimiter">(</span><a href="#48360" title="String">key</a>, <span title="Long(0L)" class="int">0</span><span class="delimiter">)</span>, <a href="#48361" title="Long">newValue</a><span class="delimiter">)</span>
      <a href="#28577" title="(key: String,value: Long)Unit">lastCounterMap</a><span class="delimiter">(</span><a href="#48360" title="String">key</a><span class="delimiter">)</span> = <a href="#48361" title="Long">newValue</a>
    <span class="delimiter">}</span>
    <a href="#48326" title="scala.collection.mutable.HashMap[String,Long]">deltas</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()scala.collection.Map[String,Double]" id="28584">getGauges</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="scala.collection.Map[String,Double]">Map</span><span class="delimiter">[</span>String, Double<span class="delimiter">]</span> = <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24035" title="()scala.collection.mutable.HashMap[String,Double]">getGauges</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()scala.collection.Map[String,String]" id="28585">getLabels</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="scala.collection.Map[String,String]">Map</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span> = <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24036" title="()scala.collection.mutable.Map[String,String]">getLabels</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]" id="28586">getMetrics</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]">Map</span><span class="delimiter">[</span>String, Distribution<span class="delimiter">]</span> = <a href="#9377" title="(x$1: scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution])scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]" id="48396">deltas</a> = <span title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">HashMap</span><span class="delimiter">[</span>String, Distribution<span class="delimiter">]</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="48430">key</a>, <a title="com.twitter.ostrich.stats.Distribution" id="48431">newValue</a><span class="delimiter">)</span> &lt;- <a href="#34021" title="com.twitter.ostrich.stats.StatsCollection">collection</a>.<a href="StatsCollection.scala.html#24034" title="()scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">getMetrics</a><a href="#48401" title="(f: ((String, com.twitter.ostrich.stats.Distribution)) =&gt; Unit)Unit" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#48396" title="(key: String,value: com.twitter.ostrich.stats.Distribution)Unit">deltas</a><span class="delimiter">(</span><a href="#48430" title="String">key</a><span class="delimiter">)</span> = <a href="Distribution.scala.html#34165" title="(other: com.twitter.ostrich.stats.Distribution)com.twitter.ostrich.stats.Distribution">newValue</a> - <a href="#28579" title="=&gt; scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">lastMetricMap</a>.<span title="(key: String,default: =&gt; com.twitter.ostrich.stats.Distribution)com.twitter.ostrich.stats.Distribution">getOrElse</span><span class="delimiter">(</span><a href="#48430" title="String">key</a>, <a href="Distribution.scala.html#34157" title="()com.twitter.ostrich.stats.Distribution" class="keyword">new</a> <a href="Distribution.scala.html#9314" title="com.twitter.ostrich.stats.Distribution">Distribution</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#28579" title="(key: String,value: com.twitter.ostrich.stats.Distribution)Unit">lastMetricMap</a><span class="delimiter">(</span><a href="#48430" title="String">key</a><span class="delimiter">)</span> = <a href="#48431" title="com.twitter.ostrich.stats.Distribution">newValue</a>
    <span class="delimiter">}</span>
    <a href="#48396" title="scala.collection.mutable.HashMap[String,com.twitter.ostrich.stats.Distribution]">deltas</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()com.twitter.ostrich.stats.StatsSummary" id="28587">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="StatsProvider.scala.html#9387" title="com.twitter.ostrich.stats.StatsSummary">StatsSummary</a> = <a href="StatsProvider.scala.html#48469" title="(counters: scala.collection.Map[String,Long],metrics: scala.collection.Map[String,com.twitter.ostrich.stats.Distribution],gauges: scala.collection.Map[String,Double],labels: scala.collection.Map[String,String])com.twitter.ostrich.stats.StatsSummary">StatsSummary</a><span class="delimiter">(</span><a href="#28583" title="()scala.collection.Map[String,Long]">getCounters</a><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#28586" title="()scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]">getMetrics</a><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#28584" title="()scala.collection.Map[String,Double]">getGauges</a><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#28585" title="()scala.collection.Map[String,String]">getLabels</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(filtered: Boolean)com.twitter.ostrich.stats.StatsSummary" id="28588">get</a><span class="delimiter">(</span><a title="Boolean" id="28592">filtered</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <a href="StatsProvider.scala.html#9387" title="com.twitter.ostrich.stats.StatsSummary">StatsSummary</a> = <span title="com.twitter.ostrich.stats.StatsSummary" class="keyword">if</span> <span class="delimiter">(</span><a href="#28592" title="Boolean">filtered</a><span class="delimiter">)</span> <a href="#28589" title="()com.twitter.ostrich.stats.StatsSummary">getFiltered</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="keyword">else</span> <a href="#28587" title="()com.twitter.ostrich.stats.StatsSummary">get</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()com.twitter.ostrich.stats.StatsSummary" id="28589">getFiltered</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="StatsProvider.scala.html#9387" title="com.twitter.ostrich.stats.StatsSummary">StatsSummary</a> = <span class="delimiter">{</span>
    <a href="#28587" title="()com.twitter.ostrich.stats.StatsSummary">get</a><span class="delimiter">(</span><span class="delimiter">)</span>.<a href="StatsProvider.scala.html#28611" title="(regex: scala.util.matching.Regex)com.twitter.ostrich.stats.StatsSummary">filterOut</a><span class="delimiter">(</span><a href="#28581" title="=&gt; scala.util.matching.Regex">filterRegex</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * A StatsListener that cycles over a given period, and once each period, grabs a snapshot of the
 * given StatsCollection and computes deltas since the previous timeslice. For example, for a
 * one-minute period, it grabs a snapshot of stats at the top of each minute, and for the rest of
 * the minute, reports these &quot;latched&quot; stats.
 */</span>
<span class="keyword">class</span> <a title="class LatchedStatsListener extends com.twitter.ostrich.stats.StatsListener with ScalaObject" id="9378">LatchedStatsListener</a><span title="ScalaObject" class="delimiter">(</span>
  <a title="com.twitter.ostrich.stats.StatsCollection" id="48158">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>,
  <a title="com.twitter.util.Duration" id="48159">period</a>: <span title="com.twitter.util.Duration">Duration</span>,
  <a title="Boolean" id="48160">startClean</a>: <span title="Boolean">Boolean</span>,
  <a title="List[scala.util.matching.Regex]" id="48161">filters</a>: <span title="List[scala.util.matching.Regex]">List</span><span class="delimiter">[</span>Regex<span class="delimiter">]</span>
<span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a><span class="delimiter">(</span><a href="#48158" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#48160" title="Boolean">startClean</a>, <a href="#48161" title="List[scala.util.matching.Regex]">filters</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(collection: com.twitter.ostrich.stats.StatsCollection,period: com.twitter.util.Duration,startClean: Boolean)com.twitter.ostrich.stats.LatchedStatsListener" id="48130" class="keyword">this</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.StatsCollection" id="48155">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>, <a title="com.twitter.util.Duration" id="48156">period</a>: <span title="com.twitter.util.Duration">Duration</span>, <a title="Boolean" id="48157">startClean</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> = <a href="#9378" title="LatchedStatsListener.this.type" class="keyword">this</a><span class="delimiter">(</span><a href="#48155" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#48156" title="com.twitter.util.Duration">period</a>, <a href="#48157" title="Boolean">startClean</a>, <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(collection: com.twitter.ostrich.stats.StatsCollection,period: com.twitter.util.Duration)com.twitter.ostrich.stats.LatchedStatsListener" id="48131" class="keyword">this</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.StatsCollection" id="48153">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a>, <a title="com.twitter.util.Duration" id="48154">period</a>: <span title="com.twitter.util.Duration">Duration</span><span class="delimiter">)</span> = <a href="#9378" title="LatchedStatsListener.this.type" class="keyword">this</a><span class="delimiter">(</span><a href="#48153" title="com.twitter.ostrich.stats.StatsCollection">collection</a>, <a href="#48154" title="com.twitter.util.Duration">period</a>, <span title="Boolean(true)" class="keyword">true</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span>

  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.collection.Map[String,Long]" id="48133">counters</a>: <span title="scala.collection.Map[String,Long]">Map</span><span class="delimiter">[</span>String, Long<span class="delimiter">]</span> = <span title="(elems: (String, Nothing)*)scala.collection.Map[String,Nothing]">Map</span><span class="delimiter">(</span><span class="delimiter">)</span>
  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.collection.Map[String,Double]" id="48136">gauges</a>: <span title="scala.collection.Map[String,Double]">Map</span><span class="delimiter">[</span>String, Double<span class="delimiter">]</span> = <span title="(elems: (String, Nothing)*)scala.collection.Map[String,Nothing]">Map</span><span class="delimiter">(</span><span class="delimiter">)</span>
  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.collection.Map[String,String]" id="48139">labels</a>: <span title="scala.collection.Map[String,String]">Map</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span> = <span title="(elems: (String, Nothing)*)scala.collection.Map[String,Nothing]">Map</span><span class="delimiter">(</span><span class="delimiter">)</span>
  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]" id="48142">metrics</a>: <span title="scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]">Map</span><span class="delimiter">[</span>String, Distribution<span class="delimiter">]</span> = <span title="(elems: (String, Nothing)*)scala.collection.Map[String,Nothing]">Map</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <a href="#48148" title="()Unit">nextLatch</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()scala.collection.Map[String,Long]" id="48144">getCounters</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#48133" title="=&gt; scala.collection.Map[String,Long]">counters</a>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()scala.collection.Map[String,Double]" id="48145">getGauges</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#48136" title="=&gt; scala.collection.Map[String,Double]">gauges</a>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()scala.collection.Map[String,String]" id="48146">getLabels</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#48139" title="=&gt; scala.collection.Map[String,String]">labels</a>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]" id="48147">getMetrics</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#48142" title="=&gt; scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]">metrics</a>

  <span class="keyword">def</span> <a title="()Unit" id="48148">nextLatch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#48133" title="(x$1: scala.collection.Map[String,Long])Unit">counters</a> = <span class="keyword">super</span>.<a href="#28583" title="()scala.collection.Map[String,Long]">getCounters</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#48139" title="(x$1: scala.collection.Map[String,String])Unit">labels</a> = <span class="keyword">super</span>.<a href="#28585" title="()scala.collection.Map[String,String]">getLabels</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#48142" title="(x$1: scala.collection.Map[String,com.twitter.ostrich.stats.Distribution])Unit">metrics</a> = <span class="keyword">super</span>.<a href="#28586" title="()scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]">getMetrics</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// do gauges last since they might be constructed using the others.</span>
    <a href="#48136" title="(x$1: scala.collection.Map[String,Double])Unit">gauges</a> = <span class="keyword">super</span>.<a href="#28584" title="()scala.collection.Map[String,Double]">getGauges</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// FIXME this would be more efficient as a Timer for all LatchedStatsListeners?</span>
  <span class="comment">// lazy to allow a subclass to override it</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="com.twitter.ostrich.admin.PeriodicBackgroundProcess" id="48150">service</a> = <a href="#48873" title="com.twitter.ostrich.admin.PeriodicBackgroundProcess" class="keyword">new</a> <a href="BackgroundProcess.scala.html#9214" title="anonymous class $anon extends com.twitter.ostrich.admin.PeriodicBackgroundProcess" id="48873">PeriodicBackgroundProcess</a><span class="delimiter">(</span><span title="java.lang.String(&quot;LatchedStatsListener&quot;)" class="string">&quot;LatchedStatsListener&quot;</span>, <a href="#48159" title="com.twitter.util.Duration">period</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="()Unit" id="48875">periodic</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#48148" title="()Unit">nextLatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <a href="ServiceTracker.scala.html#9259" title="object com.twitter.ostrich.admin.ServiceTracker">ServiceTracker</a>.<a href="ServiceTracker.scala.html#24622" title="(service: com.twitter.ostrich.admin.Service)Unit">register</a><span class="delimiter">(</span><a href="#48149" title="=&gt; com.twitter.ostrich.admin.PeriodicBackgroundProcess">service</a><span class="delimiter">)</span>
  <a href="#48149" title="=&gt; com.twitter.ostrich.admin.PeriodicBackgroundProcess">service</a>.<a href="BackgroundProcess.scala.html#24670" title="()Unit">start</a><span class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>