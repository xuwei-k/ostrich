<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Stats.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2009 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> com.twitter.ostrich.stats

<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap

<span class="comment">/**
 * Singleton StatsCollector that collects performance data for the application.
 */</span>
<span class="keyword">object</span> <a title="object com.twitter.ostrich.stats.Stats" id="9346">Stats</a> <span title="ScalaObject" class="keyword">extends</span> <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a> <span class="delimiter">{</span>
  <a href="StatsCollection.scala.html#24017" title="(x$1: Boolean)Unit">includeJvmStats</a> = <span title="Boolean(true)" class="keyword">true</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]" id="24094">namedCollections</a> = <span title="java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">ConcurrentHashMap</span><span class="delimiter">[</span>String, StatsCollection<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(128)" class="int">128</span>, <span title="Float(0.75)" class="float">0.75f</span>, <span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
  <a href="#24094" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">namedCollections</a>.<span title="(x$1: String,x$2: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsCollection">put</span><span class="delimiter">(</span><span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <a href="#9346" title="object com.twitter.ostrich.stats.Stats">Stats</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Return a named StatsCollection as defined in an AdminServiceConfig.
   * If the named collection doesn't exist, the global stats object is returned.
   */</span>
  <span class="keyword">def</span> <a title="(name: String)com.twitter.ostrich.stats.StatsCollection" id="24096">get</a><span class="delimiter">(</span><a title="String" id="44915">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.StatsCollection" id="44917">rv</a> = <a href="#24094" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">namedCollections</a>.<span title="(x$1: Any)com.twitter.ostrich.stats.StatsCollection">get</span><span class="delimiter">(</span><a href="#44915" title="String">name</a><span class="delimiter">)</span>
    <span title="com.twitter.ostrich.stats.StatsCollection" class="keyword">if</span> <span class="delimiter">(</span><a href="#44917" title="(x$1: AnyRef)Boolean">rv</a> == <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#24094" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">namedCollections</a>.<span title="(x$1: Any)com.twitter.ostrich.stats.StatsCollection">get</span><span class="delimiter">(</span><span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span> <span class="keyword">else</span> <a href="#44917" title="com.twitter.ostrich.stats.StatsCollection">rv</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Make a named StatsCollection, or return an existing collection if one already exists under
   * that name.
   */</span>
  <span class="keyword">def</span> <a title="(name: String)com.twitter.ostrich.stats.StatsCollection" id="24097">make</a><span class="delimiter">(</span><a title="String" id="38774">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.StatsCollection" id="44925">rv</a> = <a href="#24094" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">namedCollections</a>.<span title="(x$1: Any)com.twitter.ostrich.stats.StatsCollection">get</span><span class="delimiter">(</span><a href="#38774" title="String">name</a><span class="delimiter">)</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#44925" title="(x$1: AnyRef)Boolean">rv</a> == <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#24094" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">namedCollections</a>.<span title="(x$1: String,x$2: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsCollection">putIfAbsent</span><span class="delimiter">(</span><a href="#38774" title="String">name</a>, <span title="com.twitter.ostrich.stats.StatsCollection" class="keyword">new</span> <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#24094" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,com.twitter.ostrich.stats.StatsCollection]">namedCollections</a>.<span title="(x$1: Any)com.twitter.ostrich.stats.StatsCollection">get</span><span class="delimiter">(</span><a href="#38774" title="String">name</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// helper function for computing deltas over counters</span>
  <span class="keyword">def</span> <a title="(oldValue: Long,newValue: Long)Long" id="24098">delta</a><span class="delimiter">(</span><a title="Long" id="44945">oldValue</a>: <span title="Long">Long</span>, <a title="Long" id="44946">newValue</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#44945" title="(x$1: Long)Boolean">oldValue</a> &lt;= <a href="#44946" title="Long">newValue</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#44946" title="(x$1: Long)Long">newValue</a> - <a href="#44945" title="Long">oldValue</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="(x$1: Long)Long" class="delimiter">(</span>Long.<span title="(x$1: Long)Long">MaxValue</span> - <a href="#44945" title="Long">oldValue</a><span class="delimiter">)</span> <span title="(x$1: Int)Long">+</span> <span class="delimiter">(</span><a href="#44946" title="(x$1: Long)Long">newValue</a> - Long.<span title="Long(-9223372036854775808L)">MinValue</span><span class="delimiter">)</span> + <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Create a function that returns the delta of a counter each time it's called.
   */</span>
  <span class="keyword">def</span> <a title="(counter: com.twitter.ostrich.stats.Counter)() =&gt; Double" id="24099">makeDeltaFunction</a><span class="delimiter">(</span><a title="com.twitter.ostrich.stats.Counter" id="44979">counter</a>: <a href="Counter.scala.html#9305" title="com.twitter.ostrich.stats.Counter">Counter</a><span class="delimiter">)</span>: <span class="delimiter">(</span><span class="delimiter">)</span> =&gt; Double = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Long" id="44981">lastValue</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="int">0</span>

    <span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Long" id="44983">newValue</a> = <a href="Counter.scala.html#39704" title="()Long">counter</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Long" id="44984">rv</a> = <a href="#24098" title="(oldValue: Long,newValue: Long)Long">delta</a><span class="delimiter">(</span><a href="#44981" title="Long">lastValue</a>, <a href="#44983" title="Long">newValue</a><span class="delimiter">)</span>
      <a href="#44981" title="Long">lastValue</a> = <a href="#44983" title="Long">newValue</a>
      <a href="#44984" title="Long">rv</a>.<span title="=&gt; Double">toDouble</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>