<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>TimeSeriesCollector.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2010 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> com.twitter.ostrich
<span class="keyword">package</span> admin

<span class="keyword">import</span> scala.collection.<span class="delimiter">{</span>immutable, mutable<span class="delimiter">}</span>
<span class="keyword">import</span> com.sun.net.httpserver.HttpExchange
<span class="keyword">import</span> com.twitter.conversions.<span title="object com.twitter.conversions.time">time</span>._
<span class="keyword">import</span> com.twitter.json.Json
<span class="keyword">import</span> com.twitter.logging.Logger
<span class="keyword">import</span> com.twitter.util.<span class="delimiter">{</span>Duration, Time<span class="delimiter">}</span>
<span class="keyword">import</span> stats._

<span class="comment">/**
 * Collect stats over a rolling window of the last hour and report them to a web handler,
 * for generating ad-hoc realtime graphs.
 */</span>
<span class="keyword">class</span> <a title="class TimeSeriesCollector extends java.lang.Object with com.twitter.ostrich.admin.Service with ScalaObject" id="9271">TimeSeriesCollector</a><span title="ScalaObject" class="delimiter">(</span><a title="com.twitter.ostrich.stats.StatsCollection" id="34461">collection</a>: <a href="StatsCollection.scala.html#9357" title="com.twitter.ostrich.stats.StatsCollection">StatsCollection</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="Service.scala.html#9253" title="com.twitter.ostrich.admin.Service">Service</a> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="List[Double]" id="33836">PERCENTILES</a> = <span title="(xs: Double*)List[Double]">List</span><span class="delimiter">(</span><span title="Double(0.25)" class="double">0.25</span>, <span title="Double(0.5)" class="double">0.5</span>, <span title="Double(0.75)" class="double">0.75</span>, <span title="Double(0.9)" class="double">0.9</span>, <span title="Double(0.95)" class="double">0.95</span>, <span title="Double(0.99)" class="double">0.99</span>, <span title="Double(0.999)" class="double">0.999</span>, <span title="Double(0.9999)" class="double">0.9999</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="List[Long]" id="33838">EMPTY_TIMINGS</a> = <span title="object List">List</span>.<span title="(n: Int)(elem: =&gt; Long)List[Long]">fill</span><span class="delimiter">(</span><a href="#33836" title="=&gt; List[Double]">PERCENTILES</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()com.twitter.ostrich.admin.TimeSeriesCollector" id="33840" class="keyword">this</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#9271" title="TimeSeriesCollector.this.type" class="keyword">this</a><span class="delimiter">(</span><a href="Stats.scala.html#9346" title="object com.twitter.ostrich.stats.Stats">Stats</a><span class="delimiter">)</span>

  <span class="keyword">class</span> <a title="class TimeSeries[T] extends java.lang.Object with ScalaObject" id="33841">TimeSeries</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="33842">T</a><span class="delimiter">]</span><span title="ScalaObject" class="delimiter">(</span><span class="keyword">val</span> <a title="Int" id="34085">size</a>: <span title="Int">Int</span>, <a title="=&gt; T" id="34086">empty</a>: =&gt; T<span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[T]" id="34078">data</a> = <span title="()scala.collection.mutable.ArrayBuffer[T]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.ArrayBuffer[T]">ArrayBuffer</span><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="35036">i</a> &lt;- <span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> <span title="(f: (Int) =&gt; scala.collection.mutable.ArrayBuffer[T])Unit">until</span> <a href="#34085" title="=&gt; Int">size</a><span class="delimiter">)</span> <a href="#34078" title="(elem: T)TimeSeries.this.data.type">data</a> += <a href="#34086" title="=&gt; T">empty</a>
    <span class="keyword">var</span> <a title="Int" id="34081">index</a> = <span title="Int(0)" class="int">0</span>

    <span class="keyword">def</span> <a title="(n: T)Unit" id="34083">add</a><span class="delimiter">(</span><a title="T" id="34091">n</a>: <a href="#33842" title="T">T</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#34078" title="(idx: Int,elem: T)Unit">data</a><span class="delimiter">(</span><a href="#34081" title="=&gt; Int">index</a><span class="delimiter">)</span> = <a href="#34091" title="T">n</a>
      <a href="#34081" title="(x$1: Int)Unit">index</a> = <span title="(x$1: Int)Int" class="delimiter">(</span><a href="#34081" title="(x$1: Int)Int">index</a> + <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> % <a href="#34085" title="=&gt; Int">size</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="=&gt; List[T]" id="34084">toList</a>: <span title="List[T]">List</span><span class="delimiter">[</span>T<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[T]" id="35071">out</a> = <span title="scala.collection.mutable.ListBuffer[T]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.ListBuffer[T]">ListBuffer</span><span class="delimiter">[</span>T<span class="delimiter">]</span>
      <a href="#34078" title="=&gt; scala.collection.mutable.ArrayBuffer[T]">data</a>.<span title="(n: Int)scala.collection.mutable.ArrayBuffer[T]">drop</span><span class="delimiter">(</span><a href="#34081" title="=&gt; Int">index</a><span class="delimiter">)</span>.<span title="(f: (T) =&gt; scala.collection.mutable.ListBuffer[T])Unit">foreach</span> <span class="delimiter">{</span> <a href="#35071" title="(x: T)out.type">out</a> += <a href="#35416" title="T">_</a> <span class="delimiter">}</span>
      <a href="#34078" title="=&gt; scala.collection.mutable.ArrayBuffer[T]">data</a>.<span title="(from: Int,until: Int)scala.collection.mutable.ArrayBuffer[T]">slice</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#34081" title="=&gt; Int">index</a><span class="delimiter">)</span>.<span title="(f: (T) =&gt; scala.collection.mutable.ListBuffer[T])Unit">foreach</span> <span class="delimiter">{</span> <a href="#35071" title="(x: T)out.type">out</a> += <a href="#35450" title="T">_</a> <span class="delimiter">}</span>
      <a href="#35071" title="scala.collection.mutable.ListBuffer[T]">out</a>.<span title="=&gt; List[T]">toList</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]" id="33843">hourly</a> = <span title="scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]">HashMap</span><span class="delimiter">[</span>String, TimeSeries<span class="delimiter">[</span>Double<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[List[Long]]]" id="33845">hourlyTimings</a> = <span title="scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[List[Long]]]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[List[Long]]]">HashMap</span><span class="delimiter">[</span>String, TimeSeries<span class="delimiter">[</span>List<span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">var</span> <a title="com.twitter.util.Time" id="33848">lastCollection</a>: <span title="com.twitter.util.Time">Time</span> = <span title="object com.twitter.util.Time">Time</span>.<span title="=&gt; com.twitter.util.Time">epoch</span>

  <span class="keyword">val</span> <a title="&lt;refinement&gt; extends com.twitter.ostrich.admin.PeriodicBackgroundProcess" id="33850">collector</a> = <a href="#34011" title="com.twitter.ostrich.admin.PeriodicBackgroundProcess{val listener: com.twitter.ostrich.stats.StatsListener}" class="keyword">new</a> <a href="BackgroundProcess.scala.html#9214" title="anonymous class $anon extends com.twitter.ostrich.admin.PeriodicBackgroundProcess" id="34011">PeriodicBackgroundProcess</a><span class="delimiter">(</span><span title="java.lang.String(&quot;TimeSeriesCollector&quot;)" class="string">&quot;TimeSeriesCollector&quot;</span>, <span title="implicit com.twitter.conversions.time.intToTimeableNumber : (i: Int)com.twitter.conversions.time.RichWholeNumber" class="int">1</span>.<span title="=&gt; com.twitter.util.Duration">minute</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.StatsListener" id="34013">listener</a> = <a href="StatsListener.scala.html#28576" title="(collection: com.twitter.ostrich.stats.StatsCollection)com.twitter.ostrich.stats.StatsListener" class="keyword">new</a> <a href="StatsListener.scala.html#9377" title="com.twitter.ostrich.stats.StatsListener">StatsListener</a><span class="delimiter">(</span><a href="#34461" title="com.twitter.ostrich.stats.StatsCollection">collection</a><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="()Unit" id="34015">periodic</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="com.twitter.ostrich.stats.StatsSummary" id="34045">stats</a> = <a href="#34013" title="=&gt; com.twitter.ostrich.stats.StatsListener">listener</a>.<a href="StatsListener.scala.html#28587" title="()com.twitter.ostrich.stats.StatsSummary">get</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#34045" title="com.twitter.ostrich.stats.StatsSummary">stats</a>.<a href="StatsProvider.scala.html#28604" title="=&gt; scala.collection.Map[String,Double]">gauges</a>.<span title="(f: ((String, Double)) =&gt; Unit)Unit">foreach</span> <a href="#34063" title="Unit" class="delimiter">{</a> <span title="Unit" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="34066">k</a>, <a title="Double" id="34067">v</a><span class="delimiter">)</span> =&gt;
        <a href="#33843" title="=&gt; scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]">hourly</a>.<span title="(key: String,op: =&gt; TimeSeriesCollector.this.TimeSeries[Double])TimeSeriesCollector.this.TimeSeries[Double]">getOrElseUpdate</span><span class="delimiter">(</span><span title="(x$1: Any)java.lang.String" class="string">&quot;gauge:&quot;</span> + <a href="#34066" title="String">k</a>, <span title="TimeSeriesCollector.this.TimeSeries[Double]" class="keyword">new</span> <a href="#33841" title="TimeSeriesCollector.this.TimeSeries[Double]">TimeSeries</a><span class="delimiter">[</span>Double<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(60)" class="int">60</span>, <span title="Double(0.0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="#34083" title="(n: Double)Unit">add</a><span class="delimiter">(</span><a href="#34067" title="Double">v</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#34045" title="com.twitter.ostrich.stats.StatsSummary">stats</a>.<a href="StatsProvider.scala.html#28600" title="=&gt; scala.collection.Map[String,Long]">counters</a>.<span title="(f: ((String, Long)) =&gt; Unit)Unit">foreach</span> <a href="#34109" title="Unit" class="delimiter">{</a> <span title="Unit" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="34112">k</a>, <a title="Long" id="34113">v</a><span class="delimiter">)</span> =&gt;
        <a href="#33843" title="=&gt; scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]">hourly</a>.<span title="(key: String,op: =&gt; TimeSeriesCollector.this.TimeSeries[Double])TimeSeriesCollector.this.TimeSeries[Double]">getOrElseUpdate</span><span class="delimiter">(</span><span title="(x$1: Any)java.lang.String" class="string">&quot;counter:&quot;</span> + <a href="#34112" title="String">k</a>, <span title="TimeSeriesCollector.this.TimeSeries[Double]" class="keyword">new</span> <a href="#33841" title="TimeSeriesCollector.this.TimeSeries[Double]">TimeSeries</a><span class="delimiter">[</span>Double<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(60)" class="int">60</span>, <span title="Double(0.0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="#34083" title="(n: Double)Unit">add</a><span class="delimiter">(</span><a href="#34113" title="Long">v</a>.<span title="=&gt; Double">toDouble</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#34045" title="com.twitter.ostrich.stats.StatsSummary">stats</a>.<a href="StatsProvider.scala.html#28602" title="=&gt; scala.collection.Map[String,com.twitter.ostrich.stats.Distribution]">metrics</a>.<span title="(f: ((String, com.twitter.ostrich.stats.Distribution)) =&gt; Unit)Unit">foreach</span> <a href="#34133" title="Unit" class="delimiter">{</a> <span title="Unit" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="34136">k</a>, <a title="com.twitter.ostrich.stats.Distribution" id="34137">v</a><span class="delimiter">)</span> =&gt;
        <span class="keyword">val</span> <a title="List[Long]" id="34139">data</a> = <a href="#33836" title="=&gt; List[Double]">PERCENTILES</a>.<span title="(f: (Double) =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[List[Double],Long,List[Long]])List[Long]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,Long,List[Long]]" class="delimiter">{</span> <a title="Double" id="34152">percent</a> =&gt;
          <a href="#34137" title="com.twitter.ostrich.stats.Distribution">v</a>.<a href="Distribution.scala.html#34154" title="=&gt; com.twitter.ostrich.stats.Histogram">histogram</a>.<a href="Histogram.scala.html#34186" title="(percentile: Double)Int">getPercentile</a><span class="delimiter">(</span><a href="#34152" title="Double">percent</a><span class="delimiter">)</span>.<span title="=&gt; Long">toLong</span>
        <span class="delimiter">}</span>
        <a href="#33845" title="=&gt; scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[List[Long]]]">hourlyTimings</a>.<span title="(key: String,op: =&gt; TimeSeriesCollector.this.TimeSeries[List[Long]])TimeSeriesCollector.this.TimeSeries[List[Long]]">getOrElseUpdate</span><span class="delimiter">(</span><span title="(x$1: Any)java.lang.String" class="string">&quot;metric:&quot;</span> + <a href="#34136" title="String">k</a>, <span title="TimeSeriesCollector.this.TimeSeries[List[Long]]" class="keyword">new</span> <a href="#33841" title="TimeSeriesCollector.this.TimeSeries[List[Long]]">TimeSeries</a><span class="delimiter">[</span>List<span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(60)" class="int">60</span>, <a href="#33838" title="=&gt; List[Long]">EMPTY_TIMINGS</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="#34083" title="(n: List[Long])Unit">add</a><span class="delimiter">(</span><a href="#34139" title="List[Long]">data</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#33848" title="(x$1: com.twitter.util.Time)Unit">lastCollection</a> = <span title="object com.twitter.util.Time">Time</span>.<span title="=&gt; com.twitter.util.Time">now</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(name: String,selection: Seq[Int])java.lang.String" id="33852">get</a><span class="delimiter">(</span><a title="String" id="35456">name</a>: <span title="String">String</span>, <a title="Seq[Int]" id="35457">selection</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[Int]" id="35460">times</a> = <span class="delimiter">(</span><span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="35498">i</a> &lt;- <span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> <span title="(f: (Int) =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],Int,scala.collection.immutable.IndexedSeq[Int]])scala.collection.immutable.IndexedSeq[Int]">until</span> <span title="Int(60)" class="int">60</span><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">(</span><a href="#33848" title="(delta: com.twitter.util.Duration)com.twitter.util.Time">lastCollection</a> + <span class="delimiter">(</span><a href="#35498" title="(x$1: Int)Int">i</a> <span title="implicit com.twitter.conversions.time.intToTimeableNumber : (i: Int)com.twitter.conversions.time.RichWholeNumber">-</span> <span title="Int(59)" class="int">59</span><span class="delimiter">)</span>.<span title="=&gt; com.twitter.util.Duration">minutes</span><span class="delimiter">)</span>.<span title="=&gt; Int">inSeconds</span><span class="delimiter">)</span>.<span title="=&gt; List[Int]">toList</span>
    <span title="java.lang.String" class="keyword">if</span> <span class="delimiter">(</span><a href="#33843" title="=&gt; scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]">hourly</a>.<span title="(elem: String)Boolean">keySet</span> contains <a href="#35456" title="String">name</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="List[List[Double]]" id="35728">data</a> = <a href="#35460" title="List[Int]">times</a>.<span title="(that: Iterable[Double])(implicit bf: scala.collection.generic.CanBuildFrom[List[Int],(Int, Double),List[(Int, Double)]])List[(Int, Double)]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,(Int, Double),List[(Int, Double)]]" class="delimiter">(</span><a href="#33843" title="(key: String)TimeSeriesCollector.this.TimeSeries[Double]">hourly</a><span class="delimiter">(</span><a href="#35456" title="String">name</a><span class="delimiter">)</span>.<a href="#34084" title="=&gt; List[Double]">toList</a><span class="delimiter">)</span>.<span title="(f: ((Int, Double)) =&gt; List[Double])(implicit bf: scala.collection.generic.CanBuildFrom[List[(Int, Double)],List[Double],List[List[Double]]])List[List[Double]]">map</span> <a href="#36004" title="List[Double]" class="delimiter">{</a> <span title="List[Double]" class="keyword">case</span> <span class="delimiter">(</span><a title="Int" id="36007">a</a>, <a title="Double" id="36008">b</a><span class="delimiter">)</span> =&gt; <span title="(xs: Double*)List[Double]">List</span><span class="delimiter">(</span><a href="#36007" title="=&gt; Double">a</a>, <a href="#36008" title="Double">b</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span title="object com.twitter.json.Json">Json</span>.<span title="(obj: Any)com.twitter.json.JsonQuoted">build</span><span class="delimiter">(</span>immutable.<span title="(elems: (String, List[List[Double]])*)scala.collection.immutable.Map[String,List[List[Double]]]">Map</span><span class="delimiter">(</span><a href="#35456" title="(y: List[List[Double]])(String, List[List[Double]])">name</a> -&gt; <a href="#35728" title="List[List[Double]]">data</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(x$1: Any)java.lang.String">toString</span> + <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="List[List[Long]]" id="36292">timings</a> = <a href="#33845" title="(key: String)TimeSeriesCollector.this.TimeSeries[List[Long]]">hourlyTimings</a><span class="delimiter">(</span><a href="#35456" title="String">name</a><span class="delimiter">)</span>.<a href="#34084" title="=&gt; List[List[Long]]">toList</a>
      <span class="keyword">val</span> <a title="List[List[AnyVal]]" id="36293">data</a> = <a href="#35460" title="List[Int]">times</a>.<span title="(that: Iterable[List[Long]])(implicit bf: scala.collection.generic.CanBuildFrom[List[Int],(Int, List[Long]),List[(Int, List[Long])]])List[(Int, List[Long])]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,(Int, List[Long]),List[(Int, List[Long])]]" class="delimiter">(</span><a href="#36292" title="List[List[Long]]">timings</a><span class="delimiter">)</span>.<span title="(f: ((Int, List[Long])) =&gt; List[AnyVal])(implicit bf: scala.collection.generic.CanBuildFrom[List[(Int, List[Long])],List[AnyVal],List[List[AnyVal]]])List[List[AnyVal]]">map</span> <a href="#36539" title="List[AnyVal]" class="delimiter">{</a> <span title="List[AnyVal]" class="keyword">case</span> <span class="delimiter">(</span><a title="Int" id="36542">a</a>, <a title="List[Long]" id="36543">b</a><span class="delimiter">)</span> =&gt; <span title="(xs: Int*)List[Int]">List</span><span title="(that: scala.collection.TraversableOnce[AnyVal])(implicit bf: scala.collection.generic.CanBuildFrom[List[Int],AnyVal,List[AnyVal]])List[AnyVal]" class="delimiter">(</span><a href="#36542" title="Int">a</a><span class="delimiter">)</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,AnyVal,List[AnyVal]]">++</span> <a href="#36543" title="List[Long]">b</a> <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="List[List[AnyVal]]" id="36294">filteredData</a> = <a href="#36293" title="List[List[AnyVal]]">data</a>.<span title="(f: (List[AnyVal]) =&gt; List[AnyVal])(implicit bf: scala.collection.generic.CanBuildFrom[List[List[AnyVal]],List[AnyVal],List[List[AnyVal]]])List[List[AnyVal]]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,List[AnyVal],List[List[AnyVal]]]" class="delimiter">{</span>
        <a href="#37021" title="List[AnyVal]">_</a>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[List[AnyVal],(AnyVal, Int),List[(AnyVal, Int)]])List[(AnyVal, Int)]">zipWithIndex</span>.<span title="(p: ((AnyVal, Int)) =&gt; Boolean)List[(AnyVal, Int)]">filter</span> <a href="#37264" title="Boolean" class="delimiter">{</a> <span title="Boolean" class="keyword">case</span> <span class="delimiter">(</span><a title="AnyVal" id="37267">row</a>, <a title="Int" id="37268">index</a><span class="delimiter">)</span> =&gt;
          <a href="#35457" title="Seq[Int]">selection</a>.<span title="(x$1: Boolean)Boolean">isEmpty</span> <span title="(x$1: Boolean)Boolean">||</span> <a href="#37268" title="(x$1: Int)Boolean">index</a> == <span title="Int(0)" class="int">0</span> || <span class="delimiter">(</span><a href="#35457" title="(elem: Any)Boolean">selection</a> contains <a href="#37268" title="(x$1: Int)Int">index</a> - <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>.<span title="(f: ((AnyVal, Int)) =&gt; AnyVal)(implicit bf: scala.collection.generic.CanBuildFrom[List[(AnyVal, Int)],AnyVal,List[AnyVal]])List[AnyVal]">map</span> <a href="#37305" title="AnyVal" class="delimiter">{</a> <span title="AnyVal" class="keyword">case</span> <span class="delimiter">(</span><a title="AnyVal" id="37308">row</a>, <a title="Int" id="37309">index</a><span class="delimiter">)</span> =&gt; <a href="#37308" title="AnyVal">row</a> <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span title="object com.twitter.json.Json">Json</span>.<span title="(obj: Any)com.twitter.json.JsonQuoted">build</span><span class="delimiter">(</span>immutable.<span title="(elems: (String, List[List[AnyVal]])*)scala.collection.immutable.Map[String,List[List[AnyVal]]]">Map</span><span class="delimiter">(</span><a href="#35456" title="(y: List[List[AnyVal]])(String, List[List[AnyVal]])">name</a> -&gt; <a href="#36294" title="List[List[AnyVal]]">filteredData</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(x$1: Any)java.lang.String">toString</span> + <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Iterable[String]" id="33853">keys</a> = <a href="#33843" title="=&gt; scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[Double]]">hourly</a>.<span title="(that: scala.collection.TraversableOnce[String])(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[String],String,Iterable[String]])Iterable[String]">keys</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Iterable.Coll,String,Iterable[String]]">++</span> <a href="#33845" title="=&gt; scala.collection.mutable.HashMap[String,TimeSeriesCollector.this.TimeSeries[List[Long]]]">hourlyTimings</a>.<span title="=&gt; Iterable[String]">keys</span>

  <span class="keyword">def</span> <a title="(service: com.twitter.ostrich.admin.AdminHttpService)Unit" id="33854">registerWith</a><span class="delimiter">(</span><a title="com.twitter.ostrich.admin.AdminHttpService" id="37864">service</a>: <a href="AdminHttpService.scala.html#9203" title="com.twitter.ostrich.admin.AdminHttpService">AdminHttpService</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#37864" title="com.twitter.ostrich.admin.AdminHttpService">service</a>.<a href="AdminHttpService.scala.html#23247" title="(path: String,handler: com.sun.net.httpserver.HttpHandler)com.sun.net.httpserver.HttpContext">addContext</a><span class="delimiter">(</span><span title="java.lang.String(&quot;/graph/&quot;)" class="string">&quot;/graph/&quot;</span>, <span title="com.twitter.ostrich.admin.PageResourceHandler" class="keyword">new</span> <a href="AdminHttpService.scala.html#9196" title="com.twitter.ostrich.admin.PageResourceHandler">PageResourceHandler</a><span class="delimiter">(</span><span title="java.lang.String(&quot;/graph.html&quot;)" class="string">&quot;/graph.html&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#37864" title="com.twitter.ostrich.admin.AdminHttpService">service</a>.<a href="AdminHttpService.scala.html#23247" title="(path: String,handler: com.sun.net.httpserver.HttpHandler)com.sun.net.httpserver.HttpContext">addContext</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;/graph_data&quot;)" class="string">&quot;/graph_data&quot;</span>, <a href="#37872" title="com.twitter.ostrich.admin.CgiRequestHandler" class="keyword">new</a> <a href="AdminHttpService.scala.html#9200" title="anonymous class $anon extends com.twitter.ostrich.admin.CgiRequestHandler" id="37872">CgiRequestHandler</a> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(exchange: com.sun.net.httpserver.HttpExchange,path: List[String],parameters: List[(String, String)])Unit" id="37876">handle</a><span class="delimiter">(</span><a title="com.sun.net.httpserver.HttpExchange" id="37878">exchange</a>: <span title="com.sun.net.httpserver.HttpExchange">HttpExchange</span>, <a title="List[String]" id="37879">path</a>: <span title="List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span>, <a title="List[(String, String)]" id="37880">parameters</a>: <span title="List[(String, String)]">List</span><span class="delimiter">[</span><span class="delimiter">(</span>String, String<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#37879" title="List[String]">path</a>.<span title="(x$1: Int)Boolean">size</span> == <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="AdminHttpService.scala.html#11217" title="(body: String,exchange: com.sun.net.httpserver.HttpExchange)Unit">render</a><span class="delimiter">(</span><span title="object com.twitter.json.Json">Json</span>.<span title="(obj: Any)com.twitter.json.JsonQuoted">build</span><span class="delimiter">(</span><span title="(elems: (java.lang.String, List[String])*)scala.collection.immutable.Map[java.lang.String,List[String]]">Map</span><span class="delimiter">(</span><span title="(y: List[String])(java.lang.String, List[String])" class="string">&quot;keys&quot;</span> -&gt; <a href="#33853" title="=&gt; Iterable[String]">keys</a>.<span title="=&gt; List[String]">toList</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(x$1: Any)java.lang.String">toString</span> + <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>, <a href="#37878" title="com.sun.net.httpserver.HttpExchange">exchange</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Array[Int]" id="37929">keep</a> = <a href="#37880" title="List[(String, String)]">parameters</a>.<span title="(p: ((String, String)) =&gt; Boolean)List[(String, String)]">filter</span> <a href="#37932" title="Boolean" class="delimiter">{</a> <span title="Boolean" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="37935">k</a>, <a title="String" id="37936">v</a><span class="delimiter">)</span> =&gt; <a href="#37935" title="(x$1: AnyRef)Boolean">k</a> == <span title="java.lang.String(&quot;p&quot;)" class="string">&quot;p&quot;</span> <span class="delimiter">}</span>.<span title="=&gt; Option[(String, String)]">headOption</span>.<span title="(f: ((String, String)) =&gt; Array[Int])Option[Array[Int]]">map</span> <a href="#37948" title="Array[Int]" class="delimiter">{</a> <span title="Array[Int]" class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="37951">k</a>, <a title="String" id="37952">v</a><span class="delimiter">)</span> =&gt;
            <a href="#37952" title="String">v</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>.<span title="(f: (java.lang.String) =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],Int,Array[Int]])Array[Int]">map</span> <span title="(implicit m: scala.reflect.ClassManifest[Int])scala.collection.generic.CanBuildFrom[Array[_],Int,Array[Int]]" class="delimiter">{</span> <a href="#38347" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">_</a>.<span title="=&gt; Int">toInt</span> <span class="delimiter">}</span>
          <span class="delimiter">}</span>.<span title="(default: =&gt; Array[Int])Array[Int]">getOrElse</span><span class="delimiter">(</span><span class="delimiter">(</span><span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> until <a href="#33836" title="=&gt; List[Double]">PERCENTILES</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[Int])Array[Int]">toArray</span><span class="delimiter">)</span>
          <a href="AdminHttpService.scala.html#11219" title="(body: String,exchange: com.sun.net.httpserver.HttpExchange,code: Int,contentType: String)Unit">render</a><span class="delimiter">(</span><a href="#33852" title="(name: String,selection: Seq[Int])java.lang.String">get</a><span class="delimiter">(</span><a href="#37879" title="List[String]">path</a>.<span title="(n: Int)List[String]">drop</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span>, <a href="#37929" title="implicit scala.LowPriorityImplicits.wrapIntArray : (xs: Array[Int])scala.collection.mutable.WrappedArray[Int]">keep</a><span class="delimiter">)</span>, <a href="#37878" title="com.sun.net.httpserver.HttpExchange">exchange</a>, <span title="Int(200)" class="int">200</span>, <span title="java.lang.String(&quot;application/json&quot;)" class="string">&quot;application/json&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="33855">start</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#33850" title="=&gt; &lt;refinement&gt; extends com.twitter.ostrich.admin.PeriodicBackgroundProcess">collector</a>.<a href="BackgroundProcess.scala.html#24668" title="=&gt; java.lang.Thread">thread</a>.<span title="(x$1: Boolean)Unit">setDaemon</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#33850" title="=&gt; &lt;refinement&gt; extends com.twitter.ostrich.admin.PeriodicBackgroundProcess">collector</a>.<a href="BackgroundProcess.scala.html#24670" title="()Unit">start</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="33856">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#33850" title="=&gt; &lt;refinement&gt; extends com.twitter.ostrich.admin.PeriodicBackgroundProcess">collector</a>.<a href="BackgroundProcess.scala.html#24672" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>